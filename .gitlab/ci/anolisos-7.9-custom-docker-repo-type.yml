anolisos-7.9:env:custom-docker-repo-type:
  stage: env
  image: registry.cn-qingdao.aliyuncs.com/xuxiaoweicomcn/debian:curl-jq
  variables:
    QEMU_ID: $ANOLISOS_7_9_QEMU_ID
    SNAPSHOT: $ANOLISOS_7_9_SNAPSHOT
  before_script:
    - echo $PVE_ADDRESS
    - echo $ANOLISOS_7_9_QEMU_ID
    - echo $QEMU_ID
    - echo $ANOLISOS_7_9_SNAPSHOT
    - echo $SNAPSHOT
  script:
    - *env
  timeout: 120s
  rules:
    - changes:
        paths:
          - .gitlab-ci.yml
          - k8s.sh
          - tmp.sh
  tags:
    - g150s-docker
  when: manual

anolisos-7.9:install:custom-docker-repo-type:
  stage: install
  needs:
    - anolisos-7.9:env:custom-docker-repo-type
  variables:
    DOCKER_REPO_TYPE: tencent
  hooks:
    pre_get_sources_script:
      - yum install -y git
      - git config --global http.sslVerify false
  before_script:
    - cat /etc/os-release
    - ip addr | grep 'inet '
    - echo $DOCKER_REPO_TYPE
  script:
    - chmod +x tmp.sh
    - ./tmp.sh docker-repo containerd-install docker-repo-type=$DOCKER_REPO_TYPE
    - ./tmp.sh docker-repo docker-install docker-repo-type=$DOCKER_REPO_TYPE
    - ./tmp.sh kubernetes-repo kubernetes-install
    - |
      if grep -q "mirrors.cloud.tencent.com" "/etc/yum.repos.d/docker-ce.repo"; then
          echo "使用了自定义仓库";
      else
          echo "未使用自定义仓库";
          exit 1;
      fi
  rules:
    - changes:
        paths:
          - .gitlab-ci.yml
          - k8s.sh
          - tmp.sh
  tags:
    - GitLab-CICD-AnolisOS-7.9
